checks:
- id: ec2_resource_ac_2_compliance
  name: ec2_resource_ac_2_compliance
  description: Verify compliance with NIST 800-53 AC-2 Account Management for EC2 instances
  category: access_control
  output_statements:
    success: "Check passed: EC2 instances have proper IAM instance profiles and access controls"
    failure: "Check failed: EC2 instances lack proper IAM instance profiles or access controls"
    partial: "Check partially passed: Some EC2 instances have proper access controls but others need improvement"
  fix_details:
    description: "Implement proper IAM instance profiles and access controls for EC2 instances"
    instructions:
    - "Ensure all EC2 instances have IAM instance profiles attached"
    - "Review and limit IAM permissions to minimum required"
    - "Implement proper security group configurations"
    - "Enable CloudTrail logging for account management activities"
    estimated_date: "2024-12-31"
    automation_available: false
  created_by: "system"
  updated_by: "system"
  is_deleted: false
  metadata:
    resource_type: EC2Resource
    field_path: instances
    operation:
      name: custom
      logic: |
        # Check EC2 instance account management compliance
        result = False  # Default to non-compliant
        
        if fetched_value and isinstance(fetched_value, list):
            instances_with_profiles = 0
            total_instances = len(fetched_value)
            
            for instance in fetched_value:
                # Check if instance has IAM instance profile
                if instance.get('iam_instance_profile') and instance['iam_instance_profile'].get('Arn'):
                    instances_with_profiles += 1
            
            # Account management compliance criteria
            has_instances = total_instances > 0
            profile_coverage = instances_with_profiles / total_instances if total_instances > 0 else 0
            sufficient_coverage = profile_coverage >= 0.8  # At least 80% should have profiles
            
            # Check all compliance criteria
            if has_instances and sufficient_coverage:
                result = True
        elif fetched_value is None:
            # Handle case where instances data doesn't exist
            result = False
    expected_value: null
    tags:
    - compliance
    - nist
    - ac
    - ec2_resource
    severity: high
    category: access_control
    control_ids:
    - 1 